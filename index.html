<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªæ”¤åŠ©æ‰‹-å±€æ•¸çµ±è¨ˆç‰ˆ</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f7f6; padding: 20px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; border-top: 8px solid #28a745; }
        .win-gold { border-top: 8px solid #ffd700; background: #fffdf0; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        button { padding: 15px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; background: #28a745; color: white; font-weight: bold; }
        button:active { background: #1e7e34; }
        .status { margin-top: 15px; text-align: left; line-height: 1.6; display: flex; justify-content: space-between; flex-wrap: wrap; }
        .highlight { color: #d9534f; font-weight: bold; font-size: 1.3em; }
        .info-box { padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; display: none; font-size: 14px; font-weight: bold; }
        .pause-style { background: #fff3cd; color: #856404; }
        .attack-style { background: #d1ecf1; color: #0c5460; }
        .win-style { background: #d4edda; color: #155724; display: block !important; }
        .config-box { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: left; }
        .log { font-size: 12px; color: #666; height: 150px; overflow-y: scroll; border: 1px solid #ddd; padding: 5px; margin-top: 10px; background: #fafafa; text-align: left; }
        .game-count { font-size: 1.2em; color: #007bff; font-weight: bold; }
    </style>
</head> 
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28a745">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<body>
    <div id="main-card" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 1.1em; font-weight: bold;">ç•ªæ”¤æ™ºæ…§åŠ©æ‰‹</span>
            <span class="game-count">ç¬¬ <span id="display-round">0</span> å±€</span>
        </div>
        
        <div class="config-box">
            åˆå§‹æœ¬é‡‘ï¼š<input type="number" id="base-capital" value="10000" style="width:70px" onchange="resetData()"> 
            <br>æ”»å®ˆé–€æª»: <span id="threshold-text">2000</span> (20%) | æ­¢è´: 50%
        </div>

        <div id="status-warning" class="info-box"></div>

        <div id="bet-info">
            <p>ä¸‹ä¸€å±€æ³¨ç¢¼ï¼š<span class="highlight" id="next-bet">100</span></p>
            <p>å»ºè­°æŠ•æ³¨ï¼š<span class="highlight" id="next-target">è§’ 1, 2</span></p>
        </div>
        <hr>
        <div class="grid">
            <button onclick="record(1)">1</button>
            <button onclick="record(2)">2</button>
            <button onclick="record(3)">3</button>
            <button onclick="record(4)">4</button>
        </div>
        <div class="status">
            <div>ç›ˆè™§ï¼š<span id="total-profit" style="font-weight:bold;">0.0</span></div>
            <div>ç²åˆ©ç‡ï¼š<span id="profit-percent" style="font-weight:bold;">0%</span></div>
        </div>
        <div class="log" id="log">--- ç­‰å¾…ç¬¬ä¸€å±€é–‹ç ---</div>
        <button style="background:#6c757d; margin-top:15px; color:white; border:none; padding:8px; border-radius:5px; width:100%" onclick="resetData()">ğŸ” æ•¸æ“šé‡ç½®</button>
    </div>

    <script>
        let ladder = [100, 300, 700, 1500, 3100];
        let round = 0;
        let currentStep = 0;
        let totalProfit = 0;
        let missingCount = {1: 0, 2: 0, 3: 0, 4: 0};
        let lastThree = [];
        let nextTarget = [1, 2];
        let isPaused = false;
        let hasReachedWinTarget = false;

        function record(num) {
            let capital = parseFloat(document.getElementById('base-capital').value) || 10000;
            let defenseThreshold = capital * 0.20;
            let winTarget = capital * 0.50;
            document.getElementById('threshold-text').innerText = defenseThreshold.toFixed(0);

            round++;
            lastThree.push(num);
            if (lastThree.length > 3) lastThree.shift();

            // 1. æ ¸å¿ƒé‚è¼¯ï¼šé€£3ã€é€£4ã€é€£5 æŒçºŒæ ¸ç®—ç›ˆè™§
            let isStreak = (lastThree.length === 3 && lastThree[0] === lastThree[1] && lastThree[1] === lastThree[2]);
            
            if (!hasReachedWinTarget) {
                if (isStreak) {
                    if (totalProfit < defenseThreshold) {
                        isPaused = true;
                        showStatus(`âš ï¸ ç¬¬ ${round} å±€åµæ¸¬é•·é€£ï¼åˆ©æ½¤ä¸è¶³ï¼Œæš«åœé¿éšª`, "pause-style");
                    } else {
                        isPaused = false;
                        showStatus(`ğŸ”¥ ç¬¬ ${round} å±€åµæ¸¬é•·é€£ï¼åˆ©æ½¤å……è¶³ï¼Œç¹¼çºŒå¼·æ”»`, "attack-style");
                    }
                } else if (!isPaused) {
                    showStatus("", "");
                }
            }

            // 2. è™•ç†ä¸‹æ³¨çµç®—
            let betAmount = isPaused ? 0 : ladder[currentStep];
            let isWin = false;
            let roundProfit = 0;

            if (!hasReachedWinTarget && !isPaused) {
                isWin = nextTarget.includes(num);
                roundProfit = isWin ? (betAmount * 0.95) : -betAmount;
                totalProfit += roundProfit;

                if (isWin) currentStep = 0;
                else {
                    currentStep++;
                    if (currentStep >= ladder.length) currentStep = 0;
                }
                
                if (totalProfit >= winTarget) hasReachedWinTarget = true;
            }

            // 3. è™•ç†æš«åœæ¢å¾©
            if (isPaused && num !== lastThree[lastThree.length - 2]) {
                isPaused = false;
                currentStep = 0;
                showStatus("", "");
            }

            // 4. æ›´æ–°éºæ¼å€¼
            for (let i = 1; i <= 4; i++) {
                if (i === num) missingCount[i] = 0;
                else missingCount[i]++;
            }

            // 5. è¨ˆç®—ä¸‹ä¸€å±€ç›®æ¨™
            let others = [1, 2, 3, 4].filter(n => n !== num);
            others.sort((a, b) => missingCount[b] - missingCount[a]);
            nextTarget = [others[0], others[1]];

            updateUI(num, isWin, roundProfit, betAmount);
        }

        function showStatus(text, className) {
            let box = document.getElementById('status-warning');
            box.style.display = text ? 'block' : 'none';
            box.className = "info-box " + className;
            box.innerHTML = text;
        }

        function updateUI(num, isWin, roundProfit, betAmount) {
            document.getElementById('display-round').innerText = round;
            let pElem = document.getElementById('total-profit');
            pElem.innerText = totalProfit.toFixed(1);
            pElem.style.color = totalProfit >= 0 ? "green" : "red";
            
            let capital = parseFloat(document.getElementById('base-capital').value) || 10000;
            document.getElementById('profit-percent').innerText = ((totalProfit / capital) * 100).toFixed(1) + "%";

            if (hasReachedWinTarget) {
                document.getElementById('main-card').className = "card win-gold";
                showStatus(`ğŸ† é”æˆæ­¢è´ç›®æ¨™ï¼ç´¯ç©ç›ˆè™§: ${totalProfit.toFixed(0)}`, "win-style");
                document.getElementById('next-bet').innerText = "é›¢å ´";
                document.getElementById('next-target').innerText = "æ”¶å·¥å›å®¶";
            } else if (isPaused) {
                document.getElementById('next-bet').innerText = "æš«åœ";
                document.getElementById('next-target').innerText = "ç­‰è·³è™Ÿ";
            } else {
                document.getElementById('next-bet').innerText = ladder[currentStep];
                document.getElementById('next-target').innerText = "è§’ " + nextTarget.sort().join(", ");
            }

            let logBox = document.getElementById('log');
            if (logBox.innerText.includes("ç­‰å¾…")) logBox.innerHTML = "";
            let statusChar = isPaused ? "âœ‹ æš«åœ" : (isWin ? "âœ… ä¸­" : "âŒ è¼¸");
            let logMsg = `<div>[ç¬¬${round}å±€] é–‹:${num} | ${statusChar} | ç›ˆè™§:${totalProfit.toFixed(1)}</div>`;
            logBox.innerHTML = logMsg + logBox.innerHTML;
        }

        function resetData() {
            if (confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰æ•¸æ“šï¼Ÿ")) {
                round = 0; currentStep = 0; totalProfit = 0; lastThree = []; isPaused = false; hasReachedWinTarget = false;
                missingCount = {1: 0, 2: 0, 3: 0, 4: 0};
                document.getElementById('main-card').className = "card";
                document.getElementById('display-round').innerText = "0";
                document.getElementById('total-profit').innerText = "0.0";
                document.getElementById('profit-percent').innerText = "0%";
                showStatus("", "");
                document.getElementById('next-bet').innerText = "100";
                document.getElementById('next-target').innerText = "è§’ 1, 2";
                document.getElementById('log').innerHTML = "--- æ•¸æ“šå·²é‡ç½® ---";
            }
        }
    </script>
</body>
</html>
