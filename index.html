<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§åŠ©æ‰‹ V6.7</title>
    <style>
        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; background: #f0f2f5; margin: 0; padding: 15px; display: flex; justify-content: center; }
        .card { background: white; border-radius: 20px; padding: 20px; width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-top: 10px solid #28a745; position: relative; }
        /* æ­¢ç›ˆå¾Œçš„é‡‘è‰²å¤–æ®¼ */
        .card.win-gold { border-top-color: #ffd700; background: #fffdf0; }
        
        .fab { position: fixed; bottom: 80px; width: 65px; height: 65px; border-radius: 50%; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.3); z-index: 1000; border: 2px solid #fff; line-height: 1.2; }
        #diag-fab { left: 15px; background: #007bff; }
        #heguan-fab { right: 15px; background: #1a1a1a; color: #ffd700; border-color: #ffd700; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 18px; font-weight: bold; color: #333; }
        .round-tag { color: #007bff; font-weight: bold; }

        .strategy-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .strat-btn { background: #e9ecef; border: none; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: bold; color: #666; cursor: pointer; }
        .strat-btn.active { background: #007bff; color: white; }

        .bet-info { margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 12px; }
        .bet-row { font-size: 18px; margin: 5px 0; font-weight: bold; }
        .highlight-red { font-size: 26px; color: #d9534f; margin-left: 5px; }
        .ladder-hint { font-size: 14px; color: #999; font-weight: normal; }

        .num-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .num-btn { aspect-ratio: 1; border: none; border-radius: 12px; background: #28a745; color: white; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #1e7e34; }
        .num-btn:disabled { background: #ccc !important; box-shadow: 0 4px 0 #999 !important; cursor: not-allowed; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; border-top: 1px solid #eee; padding-top: 15px; font-size: 14px; text-align: left; }
        .stat-val { font-weight: bold; }
        .val-blue { color: #007bff; }
        .val-red { color: #d9534f; }

        .log-container { background: #fafafa; border: 1px solid #eee; border-radius: 10px; height: 160px; overflow-y: scroll; margin-top: 15px; padding: 10px; font-family: monospace; font-size: 12px; text-align: left; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; color: white; padding: 40px 20px; box-sizing: border-box; }
        
        #h-calc-process { margin-top: 20px; font-size: 16px; color: #aaa; min-height: 24px; font-family: monospace; }
        .warning-box { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; font-size: 14px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div id="diag-fab" class="fab" onclick="showDiag()">ğŸ“Š<br>è¨ºæ–·</div>
    <div id="heguan-fab" class="fab" onclick="toggleHeguan()">ğŸ¤µ<br>è·å®˜</div>

    <div class="card" id="main-card">
        <div class="header">
            <span class="title">æ™ºæ…§åŠ©æ‰‹ (ç­–ç•¥å„ªåŒ–ç‰ˆ)</span>
            <span class="round-tag">ç¬¬ <span id="round-num">0</span> å±€</span>
        </div>

        <div id="status-warning" class="warning-box"></div>

        <div class="strategy-grid">
            <button class="strat-btn" id="btnA" onclick="setS('A')">A é¿è·³</button>
            <button class="strat-btn" id="btnB" onclick="setS('B')">B è¿½é¾</button>
            <button class="strat-btn" id="btnC" onclick="setS('C')">C è²·å†·</button>
            <button class="strat-btn" id="btnD" onclick="setS('D')">D è²·ç†±</button>
            <button class="strat-btn active" id="btnE" onclick="setS('E')">E åå‘é™å£“</button>
            <button class="strat-btn" id="btnF" onclick="setS('F')">F å¹³è¡¡</button>
        </div>

        <div class="bet-info">
            <div class="bet-row">ä¸‹ä¸€å±€æ³¨ç¢¼ï¼š<span class="highlight-red" id="next-b">0</span> <span class="ladder-hint" id="l-hint"></span></div>
            <div class="bet-row">å»ºè­°æŠ•æ³¨ï¼š<span class="highlight-red" id="next-t">è§€å¯Ÿä¸­</span></div>
        </div>

        <div class="num-grid">
            <button class="num-btn" onclick="rec(1)">1</button>
            <button class="num-btn" onclick="rec(2)">2</button>
            <button class="num-btn" onclick="rec(3)">3</button>
            <button class="num-btn" onclick="rec(4)">4</button>
        </div>

        <div class="stats-grid">
            <div>é¤˜é¡ï¼š<span class="stat-val val-blue" id="bal">10000</span></div>
            <div>ç›ˆè™§ï¼š<span class="stat-val" id="prof">0.0</span></div>
            <div class="val-red">MDDï¼š<span class="stat-val" id="mdd">0.0%</span></div>
            <div>æœ€é«˜å³°ï¼š<span class="stat-val" id="peak">0</span></div>
        </div>

        <div class="log-container" id="log-box">--- æ•¸æ“šå°±ç·’ ---</div>

        <div style="display: flex; gap: 8px; margin-top: 15px;">
            <button onclick="exportCSV()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold;">ğŸ’¾ å­˜æª”è¨˜éŒ„</button>
            <button onclick="confirmReset()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: bold;">ğŸ”„ é‡ç½®æ•¸æ“š</button>
        </div>
    </div>

    <div id="h-panel" class="overlay">
        <div style="text-align: right;"><span onclick="toggleHeguan()" style="font-size: 40px; cursor: pointer;">Ã—</span></div>
        <div style="text-align: center; margin-top: 10vh;">
            <h2 style="color: #ffd700;">è·å®˜ä½œæ¥­ä¸­ (<span id="h-count-display">--</span> é¡†)</h2>
            <div id="h-tokens" style="display:flex; justify-content:center; flex-wrap:wrap; gap:8px; margin:30px 0; min-height:60px;"></div>
            <div id="h-res" style="font-size: 100px; font-weight: bold; color: #ffd700;">â€”</div>
            <button id="h-start-btn" onclick="hRun()" style="background:#ffd700; color:#000; border:none; padding:15px 40px; border-radius:10px; font-size:20px; font-weight:bold;">é–‹å§‹æ’¥å¼„</button>
            <div id="h-calc-process">ç­‰å¾…æ’¥å¼„...</div>
        </div>
    </div>

    <script>
        let capital = 10000, round = 0, step = 0, totalP = 0, peakP = 0, maxD = 0;
        let hist = [], logD = [], strat = 'E', target = [], counts = {1:0, 2:0, 3:0, 4:0};
        let isStopped = false; // æ–°å¢æ§åˆ¶è®Šæ•¸
        const ladF = [100, 300, 700, 1500, 3100], ladS = [100, 300, 700];

        function setS(s) { if(isStopped) return; strat = s; step = 0; document.querySelectorAll('.strat-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn'+s).classList.add('active'); calc(); updateUI(); }
        
        function calc() {
            if(isStopped) return;
            let last = hist[hist.length - 1];
            let isStreak = hist.length >= 3 && hist.slice(-3).every(x => x === last);
            if (isStreak && ['A', 'C', 'E'].includes(strat)) {
                target = [];
                document.getElementById('next-t').innerText = "é€£è™Ÿæš«åœ";
                return;
            }
            let sample = hist.slice(-12);
            let heat = {1:0, 2:0, 3:0, 4:0};
            sample.forEach(n => heat[n]++);
            let sortedByHeat = [1,2,3,4].sort((a,b) => heat[b] !== heat[a] ? heat[b] - heat[a] : counts[a] - counts[b]);

            switch(strat) {
                case 'A': target = sortedByHeat.filter(n => n !== last).slice(0, 2).sort(); break;
                case 'B': target = last ? [last, sortedByHeat.filter(n => n !== last)[0]].sort() : [1,2]; break;
                case 'C': target = [1,2,3,4].sort((a,b) => counts[b] - counts[a]).slice(0, 2).sort(); break;
                case 'D': target = sortedByHeat.slice(0, 2).sort(); break;
                case 'E': 
                    if (hist.length < 3) { target = []; document.getElementById('next-t').innerText = `è§€å¯Ÿ(${hist.length}/3)`; return; }
                    let maxC = Math.max(...Object.values(counts));
                    let colds = [1,2,3,4].filter(n => counts[n] === maxC);
                    target = (colds.length === 1) ? [1,2,3,4].filter(n => n !== colds[0] && n !== last).sort() : [];
                    break;
                case 'F': 
                    let coldOne = [1,2,3,4].sort((a,b) => counts[b] - counts[a])[0];
                    target = (last && last !== coldOne) ? [last, coldOne].sort() : sortedByHeat.slice(0, 2).sort();
                    break;
            }
            let displayStr = target.length ? target.join(",") : (strat === 'E' && hist.length >= 3 ? "å†·è™Ÿä¸å”¯ä¸€" : "è§€å¯Ÿä¸­");
            document.getElementById('next-t').innerText = displayStr;
        }

        function rec(n) {
            if (isStopped) return; // æ­¢ç›ˆæˆ–é¤˜é¡ä¸è¶³æ™‚æ‹’çµ•æ“ä½œ

            let lad = (strat === 'E') ? ladS : ladF;
            let bet = target.length ? lad[step] : 0;
            
            // --- æ–°å¢ï¼šé¤˜é¡ä¸è¶³æ””æˆª ---
            if (bet > (capital + totalP)) {
                document.getElementById('status-warning').innerText = `ğŸ”´ é¤˜é¡ä¸è¶³ (${bet})`;
                document.getElementById('status-warning').style.display = 'block';
                disableAll();
                return;
            }

            let win = target.includes(n);
            let p = bet ? (win ? bet * 0.95 : -bet) : 0;
          