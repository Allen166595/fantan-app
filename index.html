<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§åŠ©æ‰‹ V6.7 - æ·±åº¦å¾©ç›¤ç‰ˆ</title>
    <style>
        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; background: #f0f2f5; margin: 0; padding: 15px; display: flex; justify-content: center; }
        .card { background: white; border-radius: 20px; padding: 20px; width: 100%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-top: 10px solid #28a745; position: relative; }
        .fab { position: fixed; bottom: 80px; width: 65px; height: 65px; border-radius: 50%; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.3); z-index: 1000; border: 2px solid #fff; line-height: 1.2; }
        #diag-fab { left: 15px; background: #007bff; }
        #heguan-fab { right: 15px; background: #1a1a1a; color: #ffd700; border-color: #ffd700; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 18px; font-weight: bold; color: #333; }
        .round-tag { color: #007bff; font-weight: bold; }
        .strategy-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .strat-btn { background: #e9ecef; border: none; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: bold; color: #666; cursor: pointer; }
        .strat-btn.active { background: #007bff; color: white; }
        .bet-info { margin-bottom: 20px; background: #f8f9fa; padding: 12px; border-radius: 12px; }
        .bet-row { font-size: 18px; margin: 5px 0; font-weight: bold; }
        .highlight-red { font-size: 26px; color: #d9534f; margin-left: 5px; }
        .ladder-hint { font-size: 14px; color: #999; font-weight: normal; }
        .num-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .num-btn { aspect-ratio: 1; border: none; border-radius: 12px; background: #28a745; color: white; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #1e7e34; }
        .num-btn:disabled { background: #ccc !important; box-shadow: 0 4px 0 #999 !important; cursor: not-allowed; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; border-top: 1px solid #eee; padding-top: 15px; font-size: 14px; text-align: left; }
        .stat-val { font-weight: bold; }
        .val-blue { color: #007bff; }
        .val-red { color: #d9534f; }
        .log-container { background: #fafafa; border: 1px solid #eee; border-radius: 10px; height: 160px; overflow-y: scroll; margin-top: 15px; padding: 10px; font-family: monospace; font-size: 12px; text-align: left; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; color: white; padding: 40px 20px; box-sizing: border-box; }
        .warning-box { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; font-size: 14px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div id="diag-fab" class="fab" onclick="showDiag()">ğŸ“Š<br>è¨ºæ–·</div>
    <div id="heguan-fab" class="fab" onclick="toggleHeguan()">ğŸ¤µ<br>è·å®˜</div>

    <div class="card" id="main-card">
        <div class="header">
            <span class="title">æ™ºæ…§åŠ©æ‰‹ V6.7</span>
            <span class="round-tag">ç¬¬ <span id="round-num">0</span> å±€</span>
        </div>
        <div id="status-warning" class="warning-box"></div>
        <div class="strategy-grid">
            <button class="strat-btn" id="btnA" onclick="setS('A')">A é¿è·³</button>
            <button class="strat-btn" id="btnB" onclick="setS('B')">B è¿½é¾</button>
            <button class="strat-btn" id="btnC" onclick="setS('C')">C è²·å†·</button>
            <button class="strat-btn" id="btnD" onclick="setS('D')">D è²·ç†±</button>
            <button class="strat-btn active" id="btnE" onclick="setS('E')">E åå‘é™å£“</button>
            <button class="strat-btn" id="btnF" onclick="setS('F')">F å¹³è¡¡</button>
        </div>
        <div class="bet-info">
            <div class="bet-row">æ³¨ç¢¼ï¼š<span class="highlight-red" id="next-b">0</span> <span class="ladder-hint" id="l-hint"></span></div>
            <div class="bet-row">å»ºè­°ï¼š<span class="highlight-red" id="next-t">è§€å¯Ÿä¸­</span></div>
        </div>
        <div class="num-grid">
            <button class="num-btn" onclick="rec(1)">1</button>
            <button class="num-btn" onclick="rec(2)">2</button>
            <button class="num-btn" onclick="rec(3)">3</button>
            <button class="num-btn" onclick="rec(4)">4</button>
        </div>
        <div class="stats-grid">
            <div>é¤˜é¡ï¼š<span class="stat-val val-blue" id="bal">10000</span></div>
            <div>ç›ˆè™§ï¼š<span class="stat-val" id="prof">0.0</span></div>
            <div class="val-red">MDDï¼š<span class="stat-val" id="mdd">0.0%</span></div>
            <div>æœ€é«˜ï¼š<span class="stat-val" id="peak">0</span></div>
        </div>
        <div class="log-container" id="log-box">--- æ•¸æ“šå°±ç·’ ---</div>
        <div style="display: flex; gap: 8px; margin-top: 15px;">
            <button onclick="exportCSV()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold;">ğŸ’¾ å­˜æª”</button>
            <button onclick="confirmReset()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: bold;">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <div id="h-panel" class="overlay">
        <div style="text-align: right;"><span onclick="toggleHeguan()" style="font-size: 40px; cursor: pointer;">Ã—</span></div>
        <div style="text-align: center; margin-top: 10vh;">
            <h2 style="color: #ffd700;">è·å®˜ä½œæ¥­ä¸­ (<span id="h-count-display">--</span> é¡†)</h2>
            <div id="h-tokens" style="display:flex; justify-content:center; flex-wrap:wrap; gap:8px; margin:30px 0; min-height:60px;"></div>
            <div id="h-res" style="font-size: 100px; font-weight: bold; color: #ffd700;">â€”</div>
            <button id="h-start-btn" onclick="hRun()" style="background:#ffd700; color:#000; border:none; padding:15px 40px; border-radius:10px; font-size:20px; font-weight:bold;">é–‹å§‹æ’¥å¼„</button>
            <div id="h-calc-process" style="margin-top:20px; font-family:monospace; color:#aaa;">ç­‰å¾…æ’¥å¼„...</div>
        </div>
    </div>

    <script>
        let capital = 10000, round = 0, step = 0, totalP = 0, peakP = 0, maxD = 0;
        let hist = [], logD = [], strat = 'E', target = [], counts = {1:0, 2:0, 3:0, 4:0};
        let isStopped = false; 
        
        // é¡å¤–çµ±è¨ˆè®Šæ•¸ç”¨æ–¼å ±è¡¨
        let totalWagered = 0, winCount = 0, loseCount = 0, pauseCount = 0, totalCommission = 0;
        let stratTracks = []; // ç´€éŒ„ç­–ç•¥åˆ‡æ›

        const ladF = [100, 300, 700, 1500, 3100], ladS = [100, 300, 700];

        function setS(s) { 
            if(isStopped) return; 
            strat = s; 
            step = 0; 
            document.querySelectorAll('.strat-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById('btn'+s).classList.add('active'); 
            
            // ç´€éŒ„ç­–ç•¥åˆ‡æ›è»Œè·¡
            stratTracks.push({ r: round, strat: s, profit: totalP.toFixed(1) });
            
            calc(); 
            updateUI(); 
        }
        
        function calc() {
            if(isStopped) return;
            let last = hist[hist.length - 1];
            let isStreak = hist.length >= 3 && hist.slice(-3).every(x => x === last);
            if (isStreak && ['A', 'C', 'E'].includes(strat)) {
                target = [];
                document.getElementById('next-t').innerText = "é€£è™Ÿæš«åœ";
                return;
            }
            let sample = hist.slice(-12);
            let heat = {1:0, 2:0, 3:0, 4:0};
            sample.forEach(n => heat[n]++);
            let sortedByHeat = [1,2,3,4].sort((a,b) => heat[b] !== heat[a] ? heat[b] - heat[a] : counts[a] - counts[b]);

            switch(strat) {
                case 'A': target = sortedByHeat.filter(n => n !== last).slice(0, 2).sort(); break;
                case 'B': target = last ? [last, sortedByHeat.filter(n => n !== last)[0]].sort() : [1,2]; break;
                case 'C': target = [1,2,3,4].sort((a,b) => counts[b] - counts[a]).slice(0, 2).sort(); break;
                case 'D': target = sortedByHeat.slice(0, 2).sort(); break;
                case 'E': 
                    if (hist.length < 3) { target = []; document.getElementById('next-t').innerText = `è§€å¯Ÿ(${hist.length}/3)`; return; }
                    let maxC = Math.max(...Object.values(counts));
                    let colds = [1,2,3,4].filter(n => counts[n] === maxC);
                    target = (colds.length === 1) ? [1,2,3,4].filter(n => n !== colds[0] && n !== last).sort() : [];
                    break;
                case 'F': 
                    let coldOne = [1,2,3,4].sort((a,b) => counts[b] - counts[a])[0];
                    target = (last && last !== coldOne) ? [last, coldOne].sort() : sortedByHeat.slice(0, 2).sort();
                    break;
            }
            let displayStr = target.length ? target.join(",") : (strat === 'E' && hist.length >= 3 ? "å†·è™Ÿä¸å”¯ä¸€" : "è§€å¯Ÿä¸­");
            document.getElementById('next-t').innerText = displayStr;
        }

        function rec(n) {
            if (isStopped) return;
            let lad = (strat === 'E') ? ladS : ladF;
            let bet = target.length ? lad[step] : 0;
            
            if (bet > (capital + totalP)) {
                document.getElementById('status-warning').innerText = `ğŸ”´ é¤˜é¡ä¸è¶³ (${bet})`;
                document.getElementById('status-warning').style.display = 'block';
                isStopped = true;
                return;
            }

            let win = target.includes(n);
            let p = 0;
            if (bet) {
                totalWagered += bet;
                if (win) {
                    p = bet * 0.95;
                    totalCommission += (bet * 0.05);
                    winCount++;
                } else {
                    p = -bet;
                    loseCount++;
                }
            } else {
                pauseCount++;
            }

            totalP += p; peakP = Math.max(peakP, totalP); maxD = Math.max(maxD, peakP - totalP);
            
            let currentBal = (capital + totalP).toFixed(0);
            let targetStr = target.length ? target.join("/") : "æš«åœ";

            // å­˜å…¥ Log æ•¸æ“š (é…åˆ export æ¬„ä½)
            logD.push({ 
                r: round + 1, 
                strat: strat, 
                bet: bet, 
                target: targetStr, 
                open: n, 
                profit: p.toFixed(1), 
                balance: currentBal 
            });
            
            updateLog(round+1, bet, targetStr, n, win, p, currentBal);
            if (bet) { if (win) step = 0; else { step++; if (step >= lad.length) step = 0; } }
            hist.push(n); round++; [1,2,3,4].forEach(x => x === n ? counts[x]=0 : counts[x]++);
            calc(); updateUI();
        }

        function updateLog(r, b, t, n, w, p, bal) {
            let box = document.getElementById('log-box'); 
            if(box.innerText.includes("---")) {
                box.innerHTML = `<div style="color:#28a745; font-weight:bold; margin-bottom:5px;">ğŸ“ å¯¦æˆ°å›é¡§è¨˜éŒ„ (æ³¨ç¢¼/æŠ¼è§’/çµæœ/ç›ˆè™§/é¤˜é¡)ï¼š</div>`;
            }
            
            let resIcon = b === 0 ? 'âšª' : (w ? 'âœ…' : 'âŒ');
            let pStr = p >= 0 ? `+${parseFloat(p).toFixed(0)}` : `${parseFloat(p).toFixed(0)}`;
            let logLine = `<div>#${r} | ${b} / ${t} / é–‹${n}${resIcon} / ${pStr} / ${bal}</div>`;
            
            // ç²å–æ¨™é¡Œå¾Œé¢çš„å…§å®¹ä¸¦æ’å…¥æ–°ç´€éŒ„ï¼ˆè®“æœ€æ–°ç´€éŒ„åœ¨æ¨™é¡Œä¸‹æ–¹ç¬¬ä¸€è¡Œï¼‰
            let title = box.firstChild.outerHTML;
            let currentLogs = box.innerHTML.replace(title, "");
            box.innerHTML = title + logLine + currentLogs;
        }

        function updateUI() {
            document.getElementById('round-num').innerText = round;
            document.getElementById('bal').innerText = (capital + totalP).toFixed(0);
            document.getElementById('prof').innerText = totalP.toFixed(1);
            document.getElementById('peak').innerText = peakP.toFixed(0);
            document.getElementById('mdd').innerText = ((maxD/(capital+peakP))*100).toFixed(1) + "%";
            document.getElementById('next-b').innerText = target.length ? ((strat==='E'?ladS:ladF)[step]) : 0;
            document.getElementById('l-hint').innerText = strat==='E' ? "(1-3-7)" : "(1-3-7-15-31)";
        }

        // ç½®æ›ç‚ºæ·±åº¦å¾©ç›¤ç‰ˆæœ¬
        function exportCSV() {
            if (logD.length === 0) { alert("ç„¡è¨˜éŒ„å¯å­˜æª”"); return; }

            let csv = "\uFEFFå±€æ•¸,ç­–ç•¥,é‡‘é¡,çµ„åˆ,é–‹ç,ç›ˆè™§,é¤˜é¡\n";

            // æ¯å±€ç´€éŒ„
            logD.forEach(r => {
                csv += `${r.r},${r.strat},${r.bet},"${r.target}",${r.open},${r.profit},${r.balance}\n`;
            });

            // ç¸½é«”çµ±è¨ˆ
            csv += `\n--- æ·±åº¦çµ±è¨ˆå ±è¡¨ ---\n`;
            csv += `æœ€çµ‚é¤˜é¡,${(capital + totalP).toFixed(0)},ç¸½ç›ˆè™§,${totalP.toFixed(1)},ç¸½æµæ°´,${totalWagered.toFixed(0)}\n`;
            csv += `æœ€é«˜é«˜å³°,${peakP.toFixed(0)},æœ€å¤§å›å¾¹,${maxD.toFixed(0)},ä»˜å‡ºæ²¹æ°´,${totalCommission.toFixed(1)}\n`;
            csv += `ä¸­çæ¬¡æ•¸,${winCount},å‹ç‡,${(winCount/(winCount+loseCount||1)*100).toFixed(1)}%\n`;
            csv += `æ²’ä¸­æ¬¡æ•¸,${loseCount},æš«åœå±€æ•¸,${pauseCount}\n`;

            // ç­–ç•¥åˆ‡æ›è»Œè·¡
            csv += `\n--- ç­–ç•¥è»Œè·¡ç´€éŒ„ ---\nå±€æ•¸,åˆ‡æ›å‹•ä½œ,ç•¶æ™‚ç´¯è¨ˆç›ˆè™§\n`;
            stratTracks.forEach(t => {
                csv += `${t.r},åˆ‡æ›è‡³ç­–ç•¥ ${t.strat},${t.profit}\n`;
            });

            // è™Ÿç¢¼å‡ºç¾çµ±è¨ˆ
            csv += `\n--- è™Ÿç¢¼å‡ºç¾çµ±è¨ˆ ---\nè™Ÿç¢¼,æ¬¡æ•¸,ç™¾åˆ†æ¯”\n`;
            [1,2,3,4].forEach(n => {
                let c = hist.filter(x => x === n).length;
                let p = hist.length > 0 ? (c / hist.length * 100).toFixed(1) : 0;
                csv += `${n},${c}æ¬¡,${p}%\n`;
            });

            // ç”¢ç”Ÿä¸¦ä¸‹è¼‰æª”æ¡ˆ
            let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            let url = URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.href = url;
            link.download = `ç•ªæ”¤æ·±åº¦å¾©ç›¤_${new Date().getTime()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function confirmReset() {
            if (confirm("é‡ç½®æ•¸æ“šï¼Ÿ")) {
                round = 0; step = 0; totalP = 0; peakP = 0; maxD = 0; isStopped = false;
                totalWagered = 0; winCount = 0; loseCount = 0; pauseCount = 0; totalCommission = 0;
                hist = []; logD = []; stratTracks = []; counts = {1:0, 2:0, 3:0, 4:0};
                document.getElementById('log-box').innerText = "--- æ•¸æ“šå·²é‡ç½® ---";
                document.getElementById('status-warning').style.display = 'none';
                calc(); updateUI();
            }
        }

        function showDiag() { 
            if(hist.length < 5) { alert("æ•¸æ“šä¸è¶³ (éœ€5å±€ä»¥ä¸Š)"); return; }
            let sample = hist.slice(-12);
            let jumps = 0;
            for(let i=1; i<sample.length; i++) if(sample[i] !== sample[i-1]) jumps++;
            let jumpRate = (jumps / (sample.length - 1) * 100).toFixed(0);

            let recentLogs = logD.slice(-5);
            let recentWins = recentLogs.filter(l => l.w).length; 
            let recentProfit = recentLogs.reduce((sum, l) => sum + parseFloat(l.profit), 0);
            
            let gHeat = {1:0, 2:0, 3:0, 4:0};
            hist.forEach(n => gHeat[n]++);
            let gMax = [1,2,3,4].sort((a,b) => gHeat[b] - gHeat[a])[0];

            let report = `ã€æ·±åº¦è¨ºæ–·ã€‘\n`;
            report += `ç•¶å‰ç¯€å¥ï¼š${jumpRate}% (${jumpRate >= 70 ? 'å¼·è·³' : jumpRate <= 30 ? 'é•·é¾' : 'å¹³ç©©'})\n`;
            report += `è¿‘5å±€ç›ˆè™§ï¼š${recentProfit.toFixed(0)}\n`;
            report += `å…¨å±€ç†±è™Ÿï¼š[${gMax}]\n----------------\n`;

            let advice = jumpRate >= 70 ? "çµ±è¨ˆå»ºè­°ï¼š[A é¿è·³]" : (jumpRate <= 30 ? "çµ±è¨ˆå»ºè­°ï¼š[B è¿½é¾]" : "ç›¤å‹¢å¹³ç©©å»ºè­°ç¶­æŒ");
            alert(report + advice);
        }

        function toggleHeguan() { 
            let p = document.getElementById('h-panel'); 
            p.style.display = (p.style.display==='block')?'none':'block'; 
        }

        function hRun() {
            document.getElementById('h-start-btn').disabled = true;
            let sum=0, c=0, t = Math.floor(Math.random() * (20 - 13 + 1)) + 13; 
            document.getElementById('h-count-display').innerText = t;
            document.getElementById('h-tokens').innerHTML='';
            let inv = setInterval(()=>{
                let v = Math.floor(Math.random()*6)+1; sum+=v; c++;
                let d = document.createElement('div'); d.style="width:28px;height:28px;background:#ffd700;border-radius:50%;color:black;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;";
                d.innerText=v; document.getElementById('h-tokens').appendChild(d);
                if(c>=t){ 
                    clearInterval(inv); 
                    let r=(sum%4===0)?4:(sum%4); 
                    document.getElementById('h-res').innerText=r; 
                    document.getElementById('h-calc-process').innerHTML = `ç¸½å’Œ ${sum} Ã· 4 é¤˜ ${sum%4 || 4}`;
                    setTimeout(()=>{ rec(r); toggleHeguan(); document.getElementById('h-start-btn').disabled = false; }, 2000); 
                }
            }, 150);
        }
        window.onload = updateUI;
    </script>
</body>
</html>
