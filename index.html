<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç•ªæ”¤åŠ©æ‰‹-ç›ˆè™§è¿½è¹¤ç‰ˆ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #f4f7f6; padding: 15px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; border-top: 8px solid #28a745; }
        .win-gold { border-top: 8px solid #ffd700; background: #fffdf0; }
        .strong-mode { border-top: 8px solid #17a2b8; background: #f0faff; }
        .danger-mode { border-top: 8px solid #dc3545; background: #fff5f5; }
        .strategy-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px; }
        .strategy-btn { background: #e9ecef; border: 1px solid #ddd; padding: 8px; font-size: 11px; cursor: pointer; border-radius: 5px; font-weight: bold; -webkit-appearance: none; }
        .strategy-btn.active { background: #007bff; color: white; border-color: #0056b3; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        button.game-btn { padding: 18px; font-size: 20px; border: none; border-radius: 8px; cursor: pointer; background: #28a745; color: white; font-weight: bold; -webkit-appearance: none; }
        button.game-btn:disabled { background: #ccc !important; opacity: 0.6; }
        .status { margin-top: 15px; text-align: left; line-height: 1.8; border-top: 1px solid #eee; padding-top: 10px; font-size: 14px; }
        .highlight { color: #d9534f; font-weight: bold; font-size: 1.5em; }
        .info-box { padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; display: none; font-size: 13px; font-weight: bold; }
        .log { font-size: 12px; color: #333; height: 160px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; margin-top: 10px; background: #fafafa; text-align: left; font-family: monospace; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .save-btn { background: #28a745; color: white; border: none; padding: 12px; border-radius: 5px; flex: 1; cursor: pointer; font-weight: bold; -webkit-appearance: none; }
        .reset-btn { background: #6c757d; color: white; border: none; padding: 12px; border-radius: 5px; flex: 1; cursor: pointer; font-weight: bold; -webkit-appearance: none; }
    </style>
</head>
<body>
    <div id="main-card" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <span id="mode-title" style="font-weight: bold;">æ™ºæ…§åŠ©æ‰‹ (ç›ˆè™§çµ±è¨ˆå¼·åŒ–)</span>
            <span style="color:#007bff; font-weight:bold;">ç¬¬ <span id="display-round">0</span> å±€</span>
        </div>

        <div class="strategy-grid">
            <button class="strategy-btn" id="btnA" onclick="setStrat('A')">A é¿è·³</button>
            <button class="strategy-btn" id="btnB" onclick="setStrat('B')">B è¿½é¾</button>
            <button class="strategy-btn" id="btnC" onclick="setStrat('C')">C è²·å†·</button>
            <button class="strategy-btn" id="btnD" onclick="setStrat('D')">D è²·ç†±</button>
            <button class="strategy-btn active" id="btnE" onclick="setStrat('E')">E åå‘é™å£“</button>
        </div>
        
        <div id="status-warning" class="info-box"></div>

        <div id="bet-area">
            <p style="margin:5px 0;">ä¸‹ä¸€å±€æ³¨ç¢¼ï¼š<span class="highlight" id="next-bet">0</span> <small id="ladder-hint" style="color:#666;"></small></p >
            <p style="margin:5px 0;">å»ºè­°æŠ•æ³¨ï¼š<span class="highlight" id="next-target">è§€å¯Ÿä¸­</span></p >
        </div>

        <div class="grid">
            <button class="game-btn" onclick="record(1)">1</button>
            <button class="game-btn" onclick="record(2)">2</button>
            <button class="game-btn" onclick="record(3)">3</button>
            <button class="game-btn" onclick="record(4)">4</button>
        </div>

        <div class="status">
            <div style="display:flex; justify-content:space-between;">
                <span>é¤˜é¡ï¼š<span id="current-balance" style="font-weight:bold; color:#007bff;">10000</span></span>
                <span>ç›ˆè™§: <span id="total-profit" style="font-weight:bold;">0.0</span></span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size: 11px;">
                <span style="color:#dc3545; font-weight:bold;">MDD: <span id="mdd-percent">0%</span></span>
                <span>æœ€é«˜å³°: <span id="peak-val">0</span></span>
            </div>
        </div>
        
        <div class="log" id="log">--- ç­‰å¾…é–‹ç ---</div>
        
        <div class="btn-group">
            <button class="save-btn" onclick="exportToCSV()">ğŸ’¾ å­˜æª”è¨˜éŒ„</button>
            <button class="reset-btn" onclick="confirmReset()">ğŸ” é‡ç½®æ•¸æ“š</button>
        </div>
    </div>

    <script>
        let baseCapital = 10000;
        let ladderFull = [100, 300, 700, 1500, 3100];
        let ladderShort = [100, 300, 700];
        let round, currentStep, totalProfit, counts, history, currentStrat, peakProfit, maxDrawdown, winTargetReached, logData = [];
        let totalWagered = 0, totalCommission = 0, stratTracks = [];

        function init() {
            round = 0; currentStep = 0; totalProfit = 0; counts = {1:0, 2:0, 3:0, 4:0};
            history = []; peakProfit = 0; maxDrawdown = 0; winTargetReached = false; logData = [];
            totalWagered = 0; totalCommission = 0; stratTracks = [];
            setStrat('E');
            enableButtons();
            document.getElementById('main-card').className = "card";
            updateUI(); document.getElementById('log').innerHTML = "--- æ•¸æ“šå·²é‡ç½® ---";
        }

        function confirmReset() {
            if (logData.length > 0) {
                if (confirm("æ˜¯å¦è¦å­˜æª”å¾Œé‡ç½®ï¼Ÿ")) { exportToCSV(); init(); }
            } else { init(); }
        }

        function exportToCSV() {
            if (logData.length === 0) return;
            let now = new Date();
            let fileName = `ç•ªæ”¤å¾©ç›¤_${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}.csv`;
            
            let csvContent = "\uFEFFå±€æ•¸,ç­–ç•¥æ¨¡å¼,ä¸‹æ³¨é‡‘é¡,æŠ¼è§’,é–‹çè™Ÿç¢¼,å–®å±€ç›ˆè™§,ç›®å‰é¤˜é¡\n";
            logData.forEach(row => { 
                csvContent += `${row.r},${row.strat},${row.bet},"${row.target}",${row.open},${row.profit},${row.balance}\n`; 
            });

            let numCounts = {1:0, 2:0, 3:0, 4:0};
            history.forEach(h => numCounts[h]++);
            let mddP = (maxDrawdown / (baseCapital + peakProfit)) * 100;

            csvContent += `\n--- æ·±åº¦å¾©ç›¤åˆ†æ ---\n`;
            csvContent += `æœ€çµ‚é¤˜é¡,${(baseCapital + totalProfit).toFixed(0)}\n`;
            csvContent += `ç¸½ç›ˆè™§,${totalProfit.toFixed(1)}\n`;
            csvContent += `ç¸½ä¸‹æ³¨æµæ°´,${totalWagered.toFixed(0)}\n`;
            csvContent += `ä»˜å‡ºæ²¹æ°´(5%),${totalCommission.toFixed(1)}\n`;
            csvContent += `æœ€é«˜å³°å€¼,${peakProfit.toFixed(0)}\n`;
            csvContent += `æœ€å¤§å›æ’¤(MDD),${mddP.toFixed(1)}%\n`;
            
            csvContent += `\n--- ç­–ç•¥åˆ‡æ›ç´€éŒ„ ---\n`;
            csvContent += `åºè™Ÿ,å±€æ•¸,å‹•ä½œ,ç•¶æ™‚ç´¯è¨ˆç›ˆè™§\n`;
            stratTracks.forEach((t, idx) => {
                csvContent += `${idx + 1},ç¬¬ ${t.r} å±€,åˆ‡æ›ç‚ºç­–ç•¥ ${t.strat},${t.profit}\n`;
            });

            csvContent += `\n--- è™Ÿç¢¼çµ±è¨ˆ ---\n`;
            [1,2,3,4].forEach(n => {
                let count = numCounts[n];
                let percent = history.length > 0 ? ((count / history.length) * 100).toFixed(1) : 0;
                csvContent += `è™Ÿç¢¼ ${n} é–‹å‡º,${count} æ¬¡ (ä½”æ¯” ${percent}%)\n`;
            });

            const encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setStrat(s) {
            if (currentStrat === s && stratTracks.length > 0) return; 
            currentStrat = s;
            // é‡è¦ä¿®æ­£ï¼šè¨˜éŒ„ç•¶ä¸‹çš„ç›ˆè™§æ•¸å€¼
            stratTracks.push({ 
                r: round, 
                strat: s, 
                profit: totalProfit.toFixed(1) 
            });
            document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + s).classList.add('active');
            currentStep = 0; calculateTarget();
        }

        // ... record, updateUI ç­‰å‡½æ•¸ä¿æŒä¸è®Š ...
        function calculateTarget() {
            if (winTargetReached) { document.getElementById('next-target').innerText = "æ­¢è´æ”¶å·¥"; return; }
            if (history.length === 0) {
                currentTarget = (currentStrat === 'E') ? [] : [1, 2];
                document.getElementById('next-target').innerText = (currentStrat === 'E') ? "è§€å¯Ÿä¸­" : "è§’ 1, 2";
            } else {
                let last = history[history.length - 1];
                let sortedByMiss = [1, 2, 3, 4].sort((a, b) => counts[b] - counts[a]);
                let isStreak = history.length >= 3 && history.slice(-3).every(x => x === last);
                if (isStreak && currentStrat !== 'B') {
                    showWarning("âš ï¸ é€£è™Ÿæš«åœ", "background:#fff3cd; color:#856404;");
                    currentTarget = []; document.getElementById('next-target').innerText = "é€£è™Ÿæš«åœ";
                } else {
                    showWarning("");
                    if (currentStrat === 'E') {
                        if (history.length < 3) { currentTarget = []; document.getElementById('next-target').innerText = `è§€å¯ŸæœŸ(${history.length}/3)`; }
                        else {
                            let maxMiss = counts[sortedByMiss[0]];
                            let coldOnes = [1, 2, 3, 4].filter(n => counts[n] === maxMiss);
                            if (coldOnes.length === 1) { currentTarget = [1, 2, 3, 4].filter(n => n !== coldOnes[0] && n !== last).sort(); }
                            else { currentTarget = []; }
                            document.getElementById('next-target').innerText = currentTarget.length ? "è§’ " + currentTarget.join(", ") : "å†·è™Ÿä¸å”¯ä¸€";
                        }
                    } else {
                        if (currentStrat === 'A') currentTarget = sortedByMiss.filter(n => n !== last).slice(0, 2);
                        else if (currentStrat === 'B') currentTarget = [last, sortedByMiss.filter(n => n !== last)[0]];
                        else if (currentStrat === 'C') currentTarget = sortedByMiss.slice(0, 2);
                        else if (currentStrat === 'D') currentTarget = [1,2,3,4].sort((a,b) => history.filter(x=>x===b).length - history.filter(x=>x===a).length).slice(0, 2);
                        currentTarget.sort(); document.getElementById('next-target').innerText = "è§’ " + currentTarget.join(", ");
                    }
                }
            }
            refreshNextBetDisplay();
        }

        function record(num) {
            if (winTargetReached) return;
            let currentLadder = (currentStrat === 'E') ? ladderShort : ladderFull;
            let isBetting = currentTarget && currentTarget.length > 0;
            let nextBet = isBetting ? currentLadder[currentStep] : 0;
            if (isBetting && (baseCapital + totalProfit) < nextBet) { showWarning(`ğŸ”´ é¤˜é¡ä¸è¶³`, "background:#f8d7da; color:#721c24;"); disableButtons(); return; }
            
            let isWin = isBetting ? currentTarget.includes(num) : false;
            let roundProfit = 0;
            if (isBetting) {
                totalWagered += nextBet;
                if (isWin) { roundProfit = nextBet * 0.95; totalCommission += (nextBet * 0.05); } 
                else { roundProfit = -nextBet; }
            }

            totalProfit += roundProfit; 
            peakProfit = Math.max(peakProfit, totalProfit); 
            maxDrawdown = Math.max(maxDrawdown, peakProfit - totalProfit);
            
            logData.push({ 
                r: round + 1, 
                strat: currentStrat,
                bet: nextBet, 
                target: isBetting ? "è§’ " + currentTarget.join(",") : "æš«åœ", 
                open: num, 
                profit: roundProfit.toFixed(1), 
                balance: (baseCapital + totalProfit).toFixed(0)
            });

            writeLog(round + 1, nextBet, isBetting ? "è§’ " + currentTarget.join(",") : "æš«åœ", num, isWin, roundProfit);
            
            if (isBetting) { if (isWin) currentStep = 0; else { currentStep++; if (currentStep >= currentLadder.length) currentStep = 0; } }
            history.push(num); round++; for (let i = 1; i <= 4; i++) { if (i === num) counts[i] = 0; else counts[i]++; }
            if (totalProfit >= 5000) { winTargetReached = true; disableButtons(); }
            calculateTarget(); updateUI();
        }

        function writeLog(r, bet, target, openNum, win, profit) {
            let logBox = document.getElementById('log');
            if (logBox.innerHTML.includes("---")) logBox.innerHTML = "";
            let resChar = bet === 0 ? "â¸ï¸" : (win ? "âœ…" : "âŒ");
            logBox.innerHTML = `<div>(${r}) [${currentStrat}] ${bet} ${target} é–‹:${openNum} | ${resChar} ${(profit>=0?"+":"")+profit.toFixed(0)}</div>` + logBox.innerHTML;
        }

        function updateUI() {
            let card = document.getElementById('main-card');
            let title = document.getElementById('mode-title');
            if (totalProfit >= 5000) { card.className = "card win-gold"; title.innerText = "ğŸ† é”æˆæ­¢è´"; }
            else if (totalProfit >= 2000) { card.className = "card strong-mode"; title.innerText = "æ™ºæ…§åŠ©æ‰‹ (20% å¼·æ”¹)"; }
            else { card.className = "card"; title.innerText = "æ™ºæ…§åŠ©æ‰‹ (ç›ˆè™§çµ±è¨ˆå¼·åŒ–)"; }
            document.getElementById('display-round').innerText = round;
            document.getElementById('current-balance').innerText = (baseCapital + totalProfit).toFixed(0);
            document.getElementById('total-profit').innerText = totalProfit.toFixed(1);
            document.getElementById('peak-val').innerText = peakProfit.toFixed(0);
            let mddP = (maxDrawdown / (baseCapital + peakProfit)) * 100;
            document.getElementById('mdd-percent').innerText = mddP.toFixed(1) + "%";
            refreshNextBetDisplay();
        }

        function refreshNextBetDisplay() {
            let currentLadder = (currentStrat === 'E') ? ladderShort : ladderFull;
            document.getElementById('next-bet').innerText = (winTargetReached) ? "æ­¢è´" : (currentTarget.length === 0 ? "0" : currentLadder[currentStep]);
            document.getElementById('ladder-hint').innerText = (currentStrat === 'E') ? "(700)" : "(3100)";
        }

        function showWarning(m, styleStr) { let b = document.getElementById('status-warning'); if (m) { b.style.display = 'block'; b.innerText = m; b.style.cssText += styleStr; } else { b.style.display = 'none'; } }
        function disableButtons() { document.querySelectorAll('.game-btn').forEach(b => b.disabled = true); }
        function enableButtons() { document.querySelectorAll('.game-btn').forEach(b => b.disabled = false); }

        window.onload = init;
    </script>
</body>
</html>
